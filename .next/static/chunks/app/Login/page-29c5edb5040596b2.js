(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[484],{6647:function(){},5459:function(e,o,t){Promise.resolve().then(t.bind(t,9490))},9490:function(e,o,t){"use strict";t.r(o),t.d(o,{dynamic:function(){return d}});var a=t(7437),r=t(2265),s=t(6463),n=t(3580),i=t(2317),l=t(9842);let d="force-dynamic";o.default=()=>{let e=(0,s.useRouter)(),[o,t]=(0,r.useState)({email:"",password:""}),[d,c]=(0,r.useState)(!1),[u,m]=(0,r.useState)("Admin"),[f,g]=(0,r.useState)(null);(0,r.useEffect)(()=>{let o=localStorage.getItem("token"),t=localStorage.getItem("userData"),a=localStorage.getItem("selectedStoreId");if(o&&t&&a)try{let o=JSON.parse(t);"Staff"===o.roleType&&("operations"===o.accessMode||"operation"===o.accessMode)?e.push("/"):e.push("/Login")}catch(o){console.error("Error parsing userData on redirect:",o),e.push("/Login")}},[e]);let p=e=>{t({...o,[e.target.name]:e.target.value})},w=async(e,o,t,a)=>{try{let r="unknown";try{let e=await fetch("https://api.ipify.org?format=json");e.ok?r=(await e.json()).ip:console.warn("Failed to fetch IP from ipify API.")}catch(e){console.error("Error fetching IP from ipify:",e)}let s=navigator.userAgent||"unknown";await (0,l.ET)((0,l.hJ)(i.db,"user_logins"),{userId:e||"unknown_user",userType:o||"unknown",storeId:t||"unknown",storeName:a||"unknown",ip:r,timestamp:l.EK.now(),userAgent:s})}catch(e){console.error("Failed to track login:",e)}},h=async e=>{try{if(!e||"unknown"===e)return!1;let o=(0,l.hJ)(i.db,"blockip"),t=(0,l.IO)(o,(0,l.ar)("ip","==",e));return!(await (0,l.PL)(t)).empty}catch(e){return console.error("Error checking blocked IP:",e),!1}},b=async t=>{t.preventDefault(),c(!0),localStorage.removeItem("selectedStoreId"),localStorage.removeItem("selectedStore"),localStorage.removeItem("token"),localStorage.removeItem("userData");let a=null,r=null,s="",d="",m="",f=null,g=null,p=!1;try{var b,y,v,S,I,x,k;let t="unknown";try{let e=await fetch("https://api.ipify.org?format=json");if(e.ok&&(t=(await e.json()).ip,await h(t)))throw Error("Access denied: Your IP address has been blocked by an administrator. Please contact support for assistance.")}catch(e){if(e.message.includes("Access denied: Your IP address has been blocked"))throw e;console.error("Error fetching IP or checking block status:",e)}if(!o.email||!o.password)throw Error("Please provide email and password");let c=o.email.trim(),L=c.toLowerCase(),N=o.password;if(console.info("[Login] Attempt start",{loginType:u,email:L,rawEmailDifferent:c!==L}),"Admin"===u){s="clients",m="Admin";{let e=(0,l.hJ)(i.db,s),o=await (0,l.PL)((0,l.IO)(e,(0,l.ar)("email","==",L)));o.empty&&(console.debug("[Login] clients lookup with lowercased email returned empty. Trying raw email"),o=await (0,l.PL)((0,l.IO)(e,(0,l.ar)("email","==",c)))),o.empty||(r=(a=o.docs[0]).data(),console.info("[Login] Found Admin in clients",{userId:a.id,email:null==r?void 0:r.email}))}if(!a){let e=(0,l.hJ)(i.db,"storeStaff"),o=await (0,l.PL)((0,l.IO)(e,(0,l.ar)("email","==",L)));if(o.empty&&(console.debug("[Login] storeStaff lookup with lowercased email returned empty. Trying raw email"),o=await (0,l.PL)((0,l.IO)(e,(0,l.ar)("email","==",c)))),o.empty)console.warn("[Login] No records found in clients or storeStaff for provided email");else{let e=o.docs.find(e=>{var o;return"admin"===((null===(o=e.data())||void 0===o?void 0:o.accessMode)||"").toLowerCase()});e?(a=e,r=e.data(),s="storeStaff",m="Staff",p=!0,console.info("[Login] Using fallback Admin from storeStaff",{userId:a.id,email:null==r?void 0:r.email,accessMode:null==r?void 0:r.accessMode,storeId:null==r?void 0:r.storeId})):console.warn("[Login] storeStaff records found for email, but none with accessMode Admin")}}if(!a)throw Error("Invalid credentials or user not found for ".concat(u," role."))}else if("POS"===u||"Operations"===u){s="storeStaff",m="Staff";let e=(0,l.hJ)(i.db,s),o=(0,l.IO)(e,(0,l.ar)("email","==",L)),t=await (0,l.PL)(o);if(t.empty)throw Error("Invalid credentials or user not found for ".concat(u," role."));r=(a=t.docs[0]).data(),console.info("[Login] Found Staff for POS/Operations",{userId:a.id,email:null==r?void 0:r.email,accessMode:null==r?void 0:r.accessMode,storeId:null==r?void 0:r.storeId})}else throw Error("Invalid login type selected");let P=async()=>{let e=null!=r.password?String(r.password):"";if(e===N)return console.debug("[Login] Password verified"),!0;if(console.warn("[Login] Password mismatch",{userId:a.id,collectionName:s,hasStoredPassword:!!r.password,storedPasswordLength:e.length,inputPasswordLength:N.length}),"Admin"===u&&"clients"===s)try{let e=(0,l.hJ)(i.db,"storeStaff"),o=await (0,l.PL)((0,l.IO)(e,(0,l.ar)("email","==",L)));if(o.empty&&(o=await (0,l.PL)((0,l.IO)(e,(0,l.ar)("email","==",c)))),o.empty)console.warn("[Login] No storeStaff records for email during fallback");else{let e=o.docs.find(e=>{var o;return"admin"===((null===(o=e.data())||void 0===o?void 0:o.accessMode)||"").toLowerCase()});if(e){let o=e.data();if((null!=o.password?String(o.password):"")===N)return a=e,r=o,s="storeStaff",m="Staff",p=!0,console.info("[Login] Falling back to storeStaff Admin with matching password",{userId:a.id,email:null==r?void 0:r.email,accessMode:null==r?void 0:r.accessMode}),!0;console.warn("[Login] Fallback storeStaff Admin password mismatch")}else console.warn("[Login] Fallback storeStaff Admin not found for email")}}catch(e){console.error("[Login] Error during fallback staff admin lookup",e)}return!1};if(!await P())throw Error("Invalid credentials for ".concat(u," role."));if("Staff"===m){let e="Admin"===u?"admin":u.toLowerCase(),o=null===(b=r.accessMode)||void 0===b?void 0:b.toLowerCase();if(!o||o!==e)throw console.warn("[Login] Access mode check failed",{requiredAccessMode:e,userAccessMode:o,loginType:u,usedFallbackStaffAdmin:p}),Error("Login failed: You do not have permission to access the ".concat(u," portal."));if("admin"===e)d="/Admin";else if("pos"===e)d="/Pos";else if("operations"===e)d="/Admin/Operational";else throw Error("Configuration error: Invalid redirect path for staff.")}else d="/Admin";if(console.info("[Login] Role resolved",{roleType:m,redirectPath:d,usedFallbackStaffAdmin:p}),"Admin"===m){let e=(0,l.IO)((0,l.hJ)(i.db,"stores"),(0,l.ar)("adminId","==",a.id),(0,l.b9)(1)),o=await (0,l.PL)(e);if(o.empty)throw Error("Login failed: No stores are currently associated with this admin account.");let t=o.docs[0];f=t.id,g=t.data(),console.debug("[Login] Admin store selected",{selectedStoreId:f,storeName:null==g?void 0:g.storeName})}else{let e=r.storeId;if(!e)throw Error("Login failed: Store assignment is missing for this staff account.");let o=(0,l.JU)(i.db,"stores",e),t=await (0,l.QT)(o);if(!t.exists())throw Error("Login failed: Assigned store (ID: ".concat(e,") not found. Please contact support."));f=t.id,g=t.data(),console.debug("[Login] Staff store resolved",{selectedStoreId:f,storeName:null==g?void 0:g.storeName})}if(!f||!g)throw Error("Login failed: Could not retrieve store details.");if(console.info("[Login] Store details ready",{selectedStoreId:f,storeName:null==g?void 0:g.storeName}),"clients"===s&&"Demo"===r.userType&&r.createdDate){let e=r.createdDate.toDate?r.createdDate.toDate():new Date(r.createdDate),o=parseInt(r.days)||0,t=new Date,a=new Date(e);if(a.setDate(a.getDate()+o),t>a)throw Error("Your demo account has expired. Please contact support.")}let A="insecure-dev-token-".concat(a.id,"-").concat(Date.now()),j={id:a.id,email:r.email,name:r.name,roleType:m,selectedStoreId:f,selectedStoreName:g.storeName,..."Admin"===m&&{userType:r.userType,companyName:r.companyName},..."Staff"===m&&{accessMode:r.accessMode,ownerAdminId:r.userId}};localStorage.setItem("token",A);try{Object.keys(localStorage).forEach(e=>{e.startsWith("userPermissions:")&&localStorage.removeItem(e)})}catch(e){}if(localStorage.setItem("userData",JSON.stringify(j)),localStorage.setItem("selectedStoreId",f),localStorage.setItem("selectedStoredata",JSON.stringify({id:f,...g})),localStorage.setItem("selectedStore",g.storeName),await w(a.id,u,f,g.storeName),"Staff"===m)try{let e=new Date().toLocaleDateString("en-GB"),o=new Date,t=o.getHours(),s=6,n=22;try{let e=(0,l.JU)(i.db,"storeSettings",f),o=await (0,l.QT)(e);if(o.exists()){let e=o.data();s=null!==(x=null==e?void 0:null===(v=e.security)||void 0===v?void 0:null===(y=v.clockInSettings)||void 0===y?void 0:y.shiftStartHour)&&void 0!==x?x:6,n=null!==(k=null==e?void 0:null===(I=e.security)||void 0===I?void 0:null===(S=I.clockInSettings)||void 0===S?void 0:S.shiftEndHour)&&void 0!==k?k:22}}catch(e){console.warn("[Login] Could not fetch shift hours settings",e)}if(t>=s&&t<n){let t=(0,l.hJ)(i.db,"staffShifts"),s=(0,l.IO)(t,(0,l.ar)("storeId","==",f),(0,l.ar)("userId","==",a.id),(0,l.ar)("date","==",e),orderBy("createdAt","desc"),(0,l.b9)(1)),n=await (0,l.PL)(s);if(n.empty||n.docs[0].data().clockOut&&""!==n.docs[0].data().clockOut){let s=o.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),n={storeId:f,storeName:g.storeName,userId:a.id,name:r.name||r.email||"Staff",date:e,clockIn:s,clockOut:"",clockInISO:o.toISOString(),clockOutISO:"",createdAt:l.EK.now()};await (0,l.ET)(t,n),await (0,l.ET)((0,l.hJ)(i.db,"shifts"),n),console.info("[Login] Auto clock-in created for staff",{userId:a.id,time:s})}}else console.info("[Login] Auto clock-in skipped - outside shift hours",{currentHour:t,shiftStartHour:s,shiftEndHour:n,userId:a.id})}catch(e){console.warn("[Login] Auto clock-in failed",e)}n.Am.success("Logged in successfully as ".concat(u," for store: ").concat(g.storeName,"! Redirecting...")),e.push(d)}catch(o){console.error("Login error:",o),localStorage.removeItem("selectedStoreId"),localStorage.removeItem("selectedStore"),localStorage.removeItem("selectedStoredata"),localStorage.removeItem("token"),localStorage.removeItem("userData");let e=o.message.includes("Access denied: Your IP address has been blocked")?o.message:o.message.includes("credentials")||o.message.includes("not found for")?"Invalid credentials or user not found for ".concat(u,"."):o.message.includes("permission")||o.message.includes("No stores")||o.message.includes("Store assignment is missing")||o.message.includes("store (ID:")||o.message.includes("Could not retrieve store details")?o.message:o.message.includes("expired")?o.message:"Login failed for ".concat(u,". Please try again.");n.Am.error(e)}finally{c(!1)}};return(0,a.jsxs)("div",{className:"min-h-screen flex flex-col md:flex-row ",children:[(0,a.jsx)("div",{style:{backgroundImage:"url('/Login/loginleftSide.png')",backgroundSize:"cover",backgroundPosition:"center"},className:"hidden md:flex md:w-1/2 bg-blue-700 p-12 lg:p-16 flex-col justify-center relative overflow-hidden"}),(0,a.jsx)("div",{className:"w-full md:w-1/2 flex items-center justify-center p-6 md:p-12 bg-gray-50",children:(0,a.jsxs)("div",{className:"w-full max-w-md bg-white p-8 lg:p-10 rounded-lg shadow-xl space-y-6",children:[(0,a.jsx)("h2",{className:"text-2xl font-semibold text-gray-800 text-center",children:"Login with your credentials"}),(0,a.jsx)("div",{className:"flex space-x-2 border-b border-gray-200 pb-3 justify-center",children:["Admin","POS","Operations"].map(e=>(0,a.jsx)("button",{type:"button",onClick:()=>m(e),disabled:d,className:"px-5 py-2 text-sm font-medium rounded-full transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 ".concat(u===e?"bg-blue-600 text-white shadow-md scale-105":"text-gray-600 hover:bg-gray-100 border border-gray-300 hover:text-gray-800"," ").concat(d?"cursor-not-allowed opacity-70":""),children:e},e))}),(0,a.jsxs)("form",{onSubmit:b,className:"space-y-5 pt-2",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{id:"email",name:"email",type:"email",required:!0,autoComplete:"email",className:"block w-full px-3 pt-6 pb-2 border-2 rounded-md shadow-sm transition-all duration-200 ease-in-out sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed ".concat(o.email||"email"===f?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"," focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"),placeholder:" ",value:o.email,onChange:p,onFocus:()=>g("email"),onBlur:()=>g(null),disabled:d}),(0,a.jsx)("label",{htmlFor:"email",className:"absolute left-3 transition-all duration-200 ease-in-out pointer-events-none ".concat(o.email||"email"===f?"-top-2 bg-white px-1 text-xs text-blue-600 font-medium":"top-3 text-sm text-gray-500"),children:"Email"})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{id:"password",name:"password",type:"password",required:!0,autoComplete:"current-password",className:"block w-full px-3 pt-6 pb-2 border-2 rounded-md shadow-sm transition-all duration-200 ease-in-out sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed ".concat(o.password||"password"===f?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"," focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"),placeholder:" ",value:o.password,onChange:p,onFocus:()=>g("password"),onBlur:()=>g(null),disabled:d}),(0,a.jsx)("label",{htmlFor:"password",className:"absolute left-3 transition-all duration-200 ease-in-out pointer-events-none ".concat(o.password||"password"===f?"-top-2 bg-white px-1 text-xs text-blue-600 font-medium":"top-3 text-sm text-gray-500"),children:"Password"})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsx)("a",{href:"#",className:"text-sm font-medium text-blue-600 hover:text-blue-500 ".concat(d?"pointer-events-none opacity-70":""),children:"Forgot Password?"})}),(0,a.jsx)("button",{type:"submit",disabled:d,className:"w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-60 disabled:cursor-not-allowed transition-colors duration-200",children:d?(0,a.jsxs)("div",{className:"flex items-center justify-center",children:[(0,a.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Signing In..."]}):"Sign In as ".concat(u)})]})]})})]})}},2317:function(e,o,t){"use strict";t.d(o,{db:function(){return c}});var a=t(5236),r=t(9842),s=t(9930),n=t.n(s),i=t(5735),l=t(9854);n().config();let d=(0,a.ZF)({apiKey:"AIzaSyAFTMCP8Xess7YdQORSVoL-NGFDjPCnMHM",authDomain:"omebudgetapp-9f89b.firebaseapp.com",projectId:"homebudgetapp-9f89b",storageBucket:"homebudgetapp-9f89b.appspot.com",messagingSenderId:"376870799077",appId:"1:376870799077:web:63ec29e676a073f02f760c"}),c=(0,r.ad)(d);(0,i.v0)(d),(0,l.cF)(d)}},function(e){e.O(0,[358,657,218,109,580,971,23,744],function(){return e(e.s=5459)}),_N_E=e.O()}]);